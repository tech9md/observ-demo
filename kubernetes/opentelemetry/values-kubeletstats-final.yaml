# OpenTelemetry Collector - Kubelet Stats for GKE Autopilot (2026)
# Uses status.hostIP to access kubelet without hostNetwork
# Based on GKE Autopilot best practices

mode: daemonset

# DaemonSet mode - one collector per node for complete metrics coverage

image:
  repository: otel/opentelemetry-collector-contrib
  tag: "0.143.0"

# Service account for kubelet authentication
serviceAccount:
  create: true
  name: otel-collector-kubeletstats

# CRITICAL: Proper RBAC for Autopilot
clusterRole:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["nodes/stats", "nodes/metrics"]
      verbs: ["get", "list", "watch"]
    - apiGroups: [""]
      resources: ["nodes", "pods", "namespaces"]
      verbs: ["get", "list", "watch"]

# Autopilot-compliant resources - increased to trigger node scaling
resources:
  limits:
    cpu: 500m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 1Gi

# OpenTelemetry Collector Configuration
config:
  receivers:
    kubeletstats:
      collection_interval: 30s
      auth_type: "serviceAccount"  # Use service account token
      endpoint: "https://${env:K8S_NODE_IP}:10250"  # CRITICAL: Use node IP, not localhost
      insecure_skip_verify: true
      metric_groups:
        - container
        - pod
        - node
      metrics:
        # CPU metrics
        container.cpu.utilization:
          enabled: true
        container.cpu.time:
          enabled: true
        k8s.pod.cpu.utilization:
          enabled: true
        k8s.node.cpu.utilization:
          enabled: true
        # Memory metrics
        container.memory.working_set:
          enabled: true
        container.memory.available:
          enabled: true
        k8s.pod.memory.working_set:
          enabled: true
        k8s.node.memory.working_set:
          enabled: true
        # Network metrics
        k8s.pod.network.io:
          enabled: true
        container.network.io:
          enabled: true
        # Filesystem metrics
        container.filesystem.usage:
          enabled: true
        k8s.pod.filesystem.usage:
          enabled: true

  processors:
    batch:
      timeout: 10s
      send_batch_size: 512

    memory_limiter:
      check_interval: 1s
      limit_percentage: 75
      spike_limit_percentage: 25

    # Resource detection
    resourcedetection:
      detectors: [env, system]
      timeout: 5s

    # K8s attributes processor
    k8sattributes:
      auth_type: "serviceAccount"
      passthrough: false
      extract:
        metadata:
          - k8s.namespace.name
          - k8s.deployment.name
          - k8s.pod.name
          - k8s.pod.uid
          - k8s.node.name
          - k8s.container.name
      pod_association:
        - sources:
            - from: resource_attribute
              name: k8s.pod.uid

  exporters:
    # Prometheus exporter
    prometheus:
      endpoint: "0.0.0.0:8889"
      namespace: "kubeletstats"
      send_timestamps: true
      metric_expiration: 5m
      resource_to_telemetry_conversion:
        enabled: true

    # Debug exporter
    debug:
      verbosity: detailed
      sampling_initial: 5
      sampling_thereafter: 200

  extensions:
    health_check:
      endpoint: 0.0.0.0:13133

  service:
    extensions: [health_check]
    pipelines:
      metrics:
        receivers: [kubeletstats]
        processors: [memory_limiter, resourcedetection, k8sattributes, batch]
        exporters: [prometheus, debug]

# Service configuration
service:
  type: ClusterIP

# Pod annotations for Prometheus scraping
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8889"
  prometheus.io/path: "/metrics"

# CRITICAL: Environment variables to get node IP
extraEnvs:
  - name: K8S_NODE_IP
    valueFrom:
      fieldRef:
        fieldPath: status.hostIP  # This is the key - gets the node's IP
  - name: K8S_NODE_NAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName
  - name: K8S_POD_NAME
    valueFrom:
      fieldRef:
        fieldPath: metadata.name
  - name: K8S_POD_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
  - name: K8S_POD_UID
    valueFrom:
      fieldRef:
        fieldPath: metadata.uid

# Ports
ports:
  prometheus:
    enabled: true
    containerPort: 8889
    servicePort: 8889
    protocol: TCP
  health:
    enabled: true
    containerPort: 13133
    servicePort: 13133
    protocol: TCP

# Tolerations to run on all nodes
tolerations:
  - operator: "Exists"

# Disable features not needed
autoscaling:
  enabled: false

networkPolicy:
  enabled: false
