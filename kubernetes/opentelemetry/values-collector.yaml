# OpenTelemetry Collector - Open Source Observability Stack
# Deploys ONLY the OpenTelemetry Collector (not the demo app)
# This collector receives telemetry from the Microservices Demo and exports to:
# - Jaeger (distributed tracing via OTLP)
# - Prometheus (metrics)
# OPTIMIZED FOR DEMO: Minimal resources for 5-10 concurrent users

# Image configuration (required in newer chart versions)
image:
  repository: otel/opentelemetry-collector-contrib

# Deployment mode
mode: deployment

# Single replica for demo
replicaCount: 1

# GKE Autopilot minimum: 250m CPU, 512Mi memory
resources:
  limits:
    cpu: 500m
    memory: 1Gi
  requests:
    cpu: 250m
    memory: 512Mi

# OpenTelemetry Collector Configuration
config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318

  processors:
    batch:
      timeout: 10s
      send_batch_size: 512

    memory_limiter:
      check_interval: 1s
      limit_percentage: 75
      spike_limit_percentage: 25

  exporters:
    # OTLP exporter to Jaeger (Jaeger supports OTLP natively)
    otlp/jaeger:
      endpoint: jaeger-collector.observability.svc.cluster.local:4317
      tls:
        insecure: true

    # Prometheus exporter - exposes metrics for scraping
    prometheus:
      endpoint: "0.0.0.0:8889"
      namespace: "microservices"

    # Debug exporter for troubleshooting
    debug:
      verbosity: basic

  extensions:
    health_check:
      endpoint: 0.0.0.0:13133

  service:
    extensions: [health_check]
    pipelines:
      traces:
        receivers: [otlp]
        processors: [memory_limiter, batch]
        exporters: [otlp/jaeger, debug]

      metrics:
        receivers: [otlp]
        processors: [memory_limiter, batch]
        exporters: [prometheus]

      logs:
        receivers: [otlp]
        processors: [memory_limiter, batch]
        exporters: [debug]

# Service configuration
service:
  type: ClusterIP

# Pod annotations for Prometheus scraping
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8888"
  prometheus.io/path: "/metrics"

# Disable features that may cause issues
autoscaling:
  enabled: false

networkPolicy:
  enabled: false

# Ports to expose
ports:
  otlp:
    enabled: true
    containerPort: 4317
    servicePort: 4317
    protocol: TCP
  otlp-http:
    enabled: true
    containerPort: 4318
    servicePort: 4318
    protocol: TCP
  prometheus:
    enabled: true
    containerPort: 8889
    servicePort: 8889
    protocol: TCP
