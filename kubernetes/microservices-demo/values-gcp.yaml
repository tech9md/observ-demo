# Google Microservices Demo (Online Boutique) - GCP Configuration
# Helm values override for deploying to GKE with OpenTelemetry integration

# Service account with Workload Identity
serviceAccount:
  create: true
  annotations:
    iam.gke.io/gcp-service-account: "microservices-app@PROJECT_ID.iam.gserviceaccount.com"
  name: microservices-sa

# OpenTelemetry configuration for all services
opentelemetry:
  enabled: true
  collector:
    # Use the OpenTelemetry Collector from the opentelemetry namespace
    endpoint: "opentelemetry-collector.opentelemetry.svc.cluster.local:4317"

  # Resource attributes for all services
  resourceAttributes:
    deployment.environment: "demo"
    service.namespace: "microservices-demo"
    cloud.provider: "gcp"
    cloud.platform: "gcp_kubernetes_engine"

# Frontend service
frontend:
  enabled: true
  replicas: 2

  image:
    repository: gcr.io/google-samples/microservices-demo/frontend
    tag: latest
    pullPolicy: IfNotPresent

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  env:
    - name: PORT
      value: "8080"
    - name: PRODUCT_CATALOG_SERVICE_ADDR
      value: "productcatalogservice:3550"
    - name: CURRENCY_SERVICE_ADDR
      value: "currencyservice:7000"
    - name: CART_SERVICE_ADDR
      value: "cartservice:7070"
    - name: RECOMMENDATION_SERVICE_ADDR
      value: "recommendationservice:8080"
    - name: SHIPPING_SERVICE_ADDR
      value: "shippingservice:50051"
    - name: CHECKOUT_SERVICE_ADDR
      value: "checkoutservice:5050"
    - name: AD_SERVICE_ADDR
      value: "adservice:9555"
    - name: ENABLE_PROFILER
      value: "0"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "frontend"
    - name: OTEL_RESOURCE_ATTRIBUTES
      value: "service.version=1.0.0,deployment.environment=demo"

  service:
    type: LoadBalancer
    port: 80
    targetPort: 8080

# Cart service (with Redis)
cartService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/cartservice
    tag: latest

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  env:
    - name: REDIS_ADDR
      value: "redis-cart:6379"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "cartservice"

# Product Catalog service
productCatalogService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/productcatalogservice
    tag: latest

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  env:
    - name: PORT
      value: "3550"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "productcatalogservice"

# Currency service
currencyService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/currencyservice
    tag: latest

  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

  env:
    - name: PORT
      value: "7000"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "currencyservice"

# Payment service
paymentService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/paymentservice
    tag: latest

  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

  env:
    - name: PORT
      value: "50051"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "paymentservice"

# Shipping service
shippingService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/shippingservice
    tag: latest

  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

  env:
    - name: PORT
      value: "50051"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "shippingservice"

# Email service
emailService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/emailservice
    tag: latest

  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

  env:
    - name: PORT
      value: "8080"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "emailservice"

# Checkout service
checkoutService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/checkoutservice
    tag: latest

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  env:
    - name: PORT
      value: "5050"
    - name: PRODUCT_CATALOG_SERVICE_ADDR
      value: "productcatalogservice:3550"
    - name: SHIPPING_SERVICE_ADDR
      value: "shippingservice:50051"
    - name: PAYMENT_SERVICE_ADDR
      value: "paymentservice:50051"
    - name: EMAIL_SERVICE_ADDR
      value: "emailservice:5000"
    - name: CURRENCY_SERVICE_ADDR
      value: "currencyservice:7000"
    - name: CART_SERVICE_ADDR
      value: "cartservice:7070"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "checkoutservice"

# Recommendation service
recommendationService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/recommendationservice
    tag: latest

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  env:
    - name: PORT
      value: "8080"
    - name: PRODUCT_CATALOG_SERVICE_ADDR
      value: "productcatalogservice:3550"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "recommendationservice"

# Ad service
adService:
  enabled: true
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/adservice
    tag: latest

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  env:
    - name: PORT
      value: "9555"
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry.svc.cluster.local:4317"
    - name: OTEL_SERVICE_NAME
      value: "adservice"

# Redis for cart service
redis:
  enabled: true
  replica:
    replicaCount: 1

  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

  persistence:
    enabled: false  # For demo purposes, no persistence needed

# Load Generator (disabled by default, use traffic generation script)
loadGenerator:
  enabled: false
  replicas: 1

  image:
    repository: gcr.io/google-samples/microservices-demo/loadgenerator
    tag: latest

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 300m
      memory: 256Mi

  env:
    - name: FRONTEND_ADDR
      value: "frontend:80"
    - name: USERS
      value: "10"

# Ingress configuration
ingress:
  enabled: true
  className: "gce"
  annotations:
    kubernetes.io/ingress.class: "gce"
    kubernetes.io/ingress.global-static-ip-name: "REPLACE_WITH_STATIC_IP_NAME"
    ingress.gcp.kubernetes.io/pre-shared-cert: "REPLACE_WITH_SSL_CERT_NAME"
    # IAP configuration (if enabled)
    # cloud.google.com/backend-config: "iap-backend-config"

  hosts:
    - host: boutique.example.com
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: frontend
              port:
                number: 80

# Autoscaling
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70

# Network Policies
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress

  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: microservices-demo
      ports:
        - protocol: TCP
          port: 8080

  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443  # GCP APIs
        - protocol: TCP
          port: 4317  # OpenTelemetry Collector
        - protocol: TCP
          port: 53   # DNS
        - protocol: UDP
          port: 53   # DNS

# Pod Disruption Budgets
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

# Service Monitor for Prometheus (if using Managed Prometheus)
serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
